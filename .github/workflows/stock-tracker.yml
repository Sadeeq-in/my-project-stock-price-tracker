name: Stock Price Tracker Manual Run
on:
  workflow_dispatch:
    inputs:
      run_note:
        description: 'Note for this run'
        required: false
        default: 'Manual stock price collection'
        type: string

jobs:
  fetch-stock-prices:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kolkata
      DISPLAY: :99
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create input CSV file
      run: |
        mkdir -p src/main/resources
        echo "Stock Symbol" > src/main/resources/stocks_list.csv
        echo "RELIANCE" >> src/main/resources/stocks_list.csv
        echo "TCS" >> src/main/resources/stocks_list.csv
        echo "INFOSYS" >> src/main/resources/stocks_list.csv
        echo "WIPRO" >> src/main/resources/stocks_list.csv
        echo "HDFCBANK" >> src/main/resources/stocks_list.csv
        echo "BHARTIARTL" >> src/main/resources/stocks_list.csv
        echo "ITC" >> src/main/resources/stocks_list.csv
        echo "HCLTECH" >> src/main/resources/stocks_list.csv
        echo "KOTAKBANK" >> src/main/resources/stocks_list.csv
        echo "LT" >> src/main/resources/stocks_list.csv
        echo "CSV file created with stock symbols"
        cat src/main/resources/stocks_list.csv
    
    - name: Set up virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        Xvfb :99 -screen 0 1920x1080x16 > /dev/null 2>&1 &
        sleep 3
    
    - name: Install Firefox and Geckodriver manually
      run: |
        sudo apt-get install -y firefox
        firefox --version
        GECKODRIVER_VERSION="v0.33.0"
        wget -q https://github.com/mozilla/geckodriver/releases/download/${GECKODRIVER_VERSION}/geckodriver-${GECKODRIVER_VERSION}-linux64.tar.gz
        tar -xzf geckodriver-${GECKODRIVER_VERSION}-linux64.tar.gz
        chmod +x geckodriver
        sudo mv geckodriver /usr/local/bin/
        geckodriver --version
        sudo apt-get install -y libgtk-3-0 libdbus-glib-1-2 libxss1
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Show Run Information
      run: |
        echo "ğŸš€ Running Stock Price Tracker"
        echo "ğŸ“ Note: ${{ github.event.inputs.run_note }}"
        echo "ğŸ•’ Started at: $(date)"
        echo "ğŸŒ Display: $DISPLAY"
        echo "ğŸ¦ Geckodriver location: $(which geckodriver)"
        echo "ğŸ“Š Input file contents:"
        cat src/main/resources/stocks_list.csv
    
    - name: Execute Stock Price Tracker
      run: |
        export DISPLAY=:99
        mvn clean compile
        mvn exec:java -Dexec.mainClass="com.example.IndianStockPriceAutomation" -Duser.timezone=Asia/Kolkata
    
    - name: Verify output file
      run: |
        if [ -f "stock_prices_output.xlsx" ]; then
          ls -la stock_prices_output.xlsx
          echo "âœ… Stock prices file generated successfully"
        else
          echo "âŒ Stock prices file not found"
        fi
    
    - name: Upload Stock Price Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stock-prices-results-${{ github.run_number }}
        path: |
          stock_prices_output.xlsx
        retention-days: 30
    
    - name: Completion Summary
      run: |
        echo "âœ… Stock Price Tracker completed!"
        echo "ğŸ“ Check the 'Artifacts' section to download your results"
        echo "ğŸ•’ Completed at: $(date)"
