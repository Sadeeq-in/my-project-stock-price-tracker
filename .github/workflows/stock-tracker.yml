name: Stock Price Tracker Manual Run
on:
  workflow_dispatch:
    inputs:
      run_note:
        description: 'Note for this run'
        required: false
        default: 'Manual stock price collection'
        type: string

jobs:
  fetch-stock-prices:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kolkata
      DISPLAY: :99
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Create input file
      run: |
        mkdir -p src/main/resources
        echo -e "Stock Symbol\nRELIANCE\nTCS\nINFOSYS" > src/main/resources/stocks_list.xlsx
    
    - name: Set up virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        Xvfb :99 -screen 0 1920x1080x16 > /dev/null 2>&1 &
        sleep 3
    
    - name: Install Firefox and Geckodriver manually
      run: |
        # Install Firefox
        sudo apt-get install -y firefox
        firefox --version
        
        # Download and install Geckodriver manually
        GECKODRIVER_VERSION="v0.33.0"
        wget -q https://github.com/mozilla/geckodriver/releases/download/${GECKODRIVER_VERSION}/geckodriver-${GECKODRIVER_VERSION}-linux64.tar.gz
        tar -xzf geckodriver-${GECKODRIVER_VERSION}-linux64.tar.gz
        chmod +x geckodriver
        sudo mv geckodriver /usr/local/bin/
        geckodriver --version
        
        # Install additional dependencies
        sudo apt-get install -y libgtk-3-0 libdbus-glib-1-2 libxss1
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Show Run Information
      run: |
        echo "üöÄ Running Stock Price Tracker"
        echo "üìù Note: ${{ github.event.inputs.run_note }}"
        echo "üïí Started at: $(date)"
        echo "üåê Display: $DISPLAY"
        echo "ü¶é Geckodriver location: $(which geckodriver)"
    
    - name: Execute Stock Price Tracker
      run: |
        export DISPLAY=:99
        mvn clean compile
        mvn exec:java -Dexec.mainClass="com.example.IndianStockPriceAutomation" -Duser.timezone=Asia/Kolkata
    
    - name: Upload Stock Price Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stock-prices-results-${{ github.run_number }}
        path: |
          stock_prices_output.xlsx
        retention-days: 30
