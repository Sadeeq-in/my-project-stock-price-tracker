name: Stock Price Tracker Manual Run
on:
  workflow_dispatch:
    inputs:
      run_note:
        description: 'Note for this run'
        required: false
        default: 'Manual stock price collection'
        type: string

jobs:
  fetch-stock-prices:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kolkata
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set timezone to IST
      uses: szenius/set-timezone@v2.0
      with:
        timezoneLinux: "Asia/Kolkata"
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Firefox
      run: |
        sudo apt-get update
        sudo apt-get install firefox -y
        firefox --version
    
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Show Run Information
      run: |
        echo "üöÄ Running Stock Price Tracker"
        echo "üìù Note: ${{ github.event.inputs.run_note }}"
        echo "üïí Started at: $(date)"
        echo "‚è∞ Current IST time: $(TZ='Asia/Kolkata' date)"
        echo "üåê System timezone: $(timedatectl | grep 'Time zone' || echo 'Timezone info not available')"
        echo "üìÖ Current date in IST: $(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M:%S')"
    
    - name: Verify Java timezone
      run: |
        echo "Java system timezone:"
        java -XshowSettings:locale -version 2>&1 | grep -i timezone || true
        java -Duser.timezone=Asia/Kolkata -cp . -c "System.out.println(java.time.ZoneId.systemDefault());" || echo "Java timezone verification skipped"
    
    - name: Execute Stock Price Tracker
      run: |
        echo "Starting Maven build..."
        mvn clean compile
        echo "Running stock price tracker with IST timezone..."
        mvn exec:java -Dexec.mainClass="com.example.IndianStockPriceAutomation" -Duser.timezone=Asia/Kolkata
    
    - name: Verify output timestamp
      run: |
        echo "Checking generated Excel file timestamp..."
        if [ -f "stock_prices_output.xlsx" ]; then
          ls -la stock_prices_output.xlsx
          echo "‚úÖ Stock prices file generated successfully"
        else
          echo "‚ùå Stock prices file not found"
        fi
    
    - name: Upload Stock Price Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stock-prices-results-${{ github.run_number }}
        path: |
          stock_prices_output.xlsx
        retention-days: 30
    
    - name: Completion Summary
      run: |
        echo "‚úÖ Stock Price Tracker completed!"
        echo "üìÅ Check the 'Artifacts' section to download your results"
        echo "üïí Completed at: $(TZ='Asia/Kolkata' date)"
        echo "üìä Data collected with IST timestamps for consistency"
